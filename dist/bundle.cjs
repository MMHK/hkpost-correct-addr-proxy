(()=>{"use strict";var e={433:(e,t,r)=>{r.r(t),r.d(t,{StartService:()=>h,default:()=>f});const s=require("fastify"),i=require("@fastify/swagger"),n=require("@fastify/swagger-ui"),a=require("axios"),o=require("cheerio"),d=process.env.API_ENDPOINT||"https://webapp.hongkongpost.hk/correct_addressing";function c(e,t){const r=(0,o.load)(e),s=[],i=[];return r(t).find("th").each(((e,t)=>{i.push(r(t).text().trim().replace("null",""))})),r(t).find("tr").each(((e,t)=>{if(0!==e){const e={};r(t).find("td").each(((t,s)=>{const n=i[t],a=/\(([^)]+)\)/i,o=r(s).text().trim()||"",d=a.exec(o);d&&(e[`${n}-en`]=o.replace(a,"").trim(),e[`${n}-zh`]=(d[1]||"").trim())})),s.push(e)}})),s.filter((e=>e)).map((e=>Object.fromEntries(Object.entries(e).filter((([e,t])=>e))))).filter((e=>Object.keys(e).length>0))}const p={scoreStrings:function(e,t){return e.reduce(((e,r)=>{const s=new RegExp(`(${r})`,"ig");return e+(t.match(s)||[]).length}),0)},async getBuildingAddress(e={building:""}){const t={iseng:"true",n:4,a:1,currpage:1,lang1:"en",...e},r=new URLSearchParams;return Object.entries(t).forEach((([e,t])=>{r.append(e,t)})),c((await a.get(`${d}/GetBuildingAddr.jsp?${r.toString()}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}})).data||"",".tableb")},async getStreetAddress(e={street:"",key:""}){const t={iseng:"true",n:50,a:1,currpage:1,lang1:"en",...e},r=new URLSearchParams;return Object.entries(t).forEach((([e,t])=>{r.append(e,t)})),c((await a.get(`${d}/GetStreetAddr.jsp?${r.toString()}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}})).data||"",".tables")}},l=process.env.DATA_GOV_HK_ENDPOINT||"https://www.als.ogcio.gov.hk",g=process.env.GEO_GOV_HK_ENDPOINT||"https://geodata.gov.hk/gs/api/v1.0.0",u={async lookup(e,t=20){const r=new URLSearchParams;r.append("q",e),r.append("n",t);const s=await a.get(`${l}/lookup?${r.toString()}`,{headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}});return(s.data?.SuggestedAddress||[]).map((e=>function(e){let t=e.Address.PremisesAddress.EngPremisesAddress.EngBlock?.BlockNo||"",r=e.Address.PremisesAddress.EngPremisesAddress.EngBlock?.BlockName||"";t&&(r=`${r} ${t}`);let s=e.Address.PremisesAddress.EngPremisesAddress.EngStreet?.BuildingNoFrom||"",i=e.Address.PremisesAddress.EngPremisesAddress.EngStreet?.BuildingNoTo||"";i&&s&&(s=`${s}-${i}}`);let n=e.Address.PremisesAddress.EngPremisesAddress.EngDistrict?.DcDistrict||"";return{addr_block:r,addr_bldg:e.Address.PremisesAddress.EngPremisesAddress.BuildingName||"",addr_st_no:s,addr_st_name:e.Address.PremisesAddress.EngPremisesAddress.EngStreet?.StreetName||"",addr_estate:e.Address.PremisesAddress.EngPremisesAddress.EngEstate?.EstateName||"",addr_district:n.replace(/( DISTRICT)$/i,""),score:e.ValidationInformation?.Score||0}}(e))).filter((e=>e.score>=50))},async locationSearch(e){const t=new URLSearchParams;return t.append("q",e),((await a.get(`${g}/locationSearch?${t.toString()}`,{headers:{Accept:"application/json","User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}})).data||[]).map((e=>({address:e.addressEN,district:e.districtEN,name:e.nameEN})))}},m=async(e,t)=>{if(!process.env.AUTH_TOKEN)return;const{headers:r}=e,s=r.authorization;return s&&s===process.env.AUTH_TOKEN?void 0:(console.error("Unauthorized"),t.send({text:"Unauthorized"},406))},y=s({bodyLimit:10485760,logger:{transport:{target:"@fastify/one-line-logger"}}}),h=async(e=null)=>{e||(e=process.env.PORT||3e3),await(async e=>{await e.register(i,{swagger:{mode:"dynamic",info:{title:"Proxy for HongKong Post Correct Addressing Services",description:"透過此 API 寻找正确的香港地址",version:"1.0.0"},consumes:["application/json"],produces:["application/json"],securityDefinitions:{bearerAuth:{type:"apiKey",schema:"bearer",name:"Authorization",in:"header"}}}}),await e.addHook("onRequest",((t,r,s)=>{let i=t.headers["x-forwarded-host"]||t.headers.host;t.headers["x-forwarded-proto"]||t.protocol,`${i}`.includes(",")&&(i=i.split(",")[0]),e.swagger().host=`${i}`,s()}))})(y),await(e=>e.register(n,{routePrefix:"/swagger",uiConfig:{docExpansion:"full",deepLinking:!1},uiHooks:{onRequest:function(e,t,r){r()},preHandler:function(e,t,r){r()}},staticCSP:!0,transformStaticCSP:e=>e,transformSpecification:(e,t,r)=>e,exposeRoute:!0}))(y),(e=>{e.get("/",{schema:{hide:!0}},(async(e,t)=>t.redirect("/swagger"))),e.get("/api/format",{preHandler:m,schema:{security:process.env.AUTH_TOKEN?[{bearerAuth:[]}]:void 0,tags:["DATAGOVHK"],summary:"查找符合格式的HK地址",consumes:["application/json"],querystring:{type:"object",properties:{address:{type:"string",description:"地址"}}},response:{default:{type:"object",properties:{status:{type:"boolean",description:"是否成功"},result:{type:"array",description:"結果",items:{type:"object",properties:{addr_block:{type:"string",description:"區域"},addr_bldg:{type:"string",description:"大廈/建築名稱"},addr_st_no:{type:"string",description:"門牌號碼"},addr_st_name:{type:"string",description:"街道名稱"},addr_estate:{type:"string",description:"屋邨名稱"},addr_district:{type:"string",description:"地區"},score:{type:"number",description:"相似度 100满分"}}}}}}}},handler:async(e,t)=>{const{address:r}=e.query,s=await u.lookup(r);return t.send({status:!0,result:s})}}),e.get("/api/lookup",{preHandler:m,schema:{security:process.env.AUTH_TOKEN?[{bearerAuth:[]}]:void 0,tags:["HKPost"],summary:"透過此 API 尋找正確的香港地址",consumes:["application/json"],querystring:{type:"object",properties:{street:{type:"string",description:"街道或者屋邨名(不帶編號)"},building:{type:"string",description:"樓宇/大廈/建築名稱"},estate:{type:"string",description:"屋邨名稱"}}},response:{default:{type:"object",properties:{status:{type:"boolean",description:"是否成功"},result:{type:"array",description:"結果",items:{type:"object",properties:{district:{type:"string",description:"地區"},street:{type:"string",description:"街道"},building:{type:"string",description:"大廈/建築名稱"},score:{type:"number",description:"相似度"}}}},error:{type:"string",description:"錯誤信息"}}}}}},(async(e,t)=>{let{street:r,building:s,estate:i}=e.query;r=(r||"").replace(/(rd|road|st|street)$/gi,""),s=(s||"").replace(/(house|building)$/gi,""),i=(i||"").replace(/(estate|villa|village)$/gi,""),console.log({street:r,building:s,estate:i});try{let e=[],n=Array.from(new Set([s,i].map((e=>e.replace(/(the|park|tower)/gi,"").split(/\W+/))).flat(1))).filter((e=>e)),a=!1;r&&(0===n.length&&(n=[""]),e=await Promise.all(n.map((e=>p.getStreetAddress({street:r,key:e})))),e.filter((e=>e instanceof Array&&e.length>0)).length>0&&(a=!0)),a||(n=[s,i,r].map((e=>e.replace(/(the|park|tower)/gi,"").trim())).filter((e=>e)),n.length>0&&(e=await Promise.all(n.map((e=>p.getBuildingAddress({building:e}))))));let o=e.filter((e=>e instanceof Array&&e.length>0)).reduce(((e,t)=>e.concat(t)),[]).map((e=>[`${e["District-en"]||""}${e["Street-en"]||""}${e["Building-en"]||""}`,e]));return e=Object.values(Object.fromEntries(o)),n=n.map((e=>e.split(/\W+/))).flat(1).filter((e=>e)),console.log("search keys",n),e=e.map((e=>{let t={...e,"District-en":"","District-zh":""};const r=p.scoreStrings(n,JSON.stringify(t));return{...e,score:r}})).sort(((e,t)=>t.score-e.score)),console.log(e),e instanceof Array&&e.length>0?t.status(200).send({status:!0,result:e.map((e=>({district:e["District-en"]||"",street:e["Street-en"]||"",building:e["Building-en"]||"",score:e.score||0})))}):t.status(200).send({status:!1,error:"找不到相關地址"})}catch(e){return t.status(500).send({status:!1,error:e.message})}}))})(y),await y.ready(),y.listen({host:"0.0.0.0",port:e},((e,t)=>{e&&(console.error(e),process.exit(1)),console.log(`Server listening at ${t}`)}))},f=h}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};const s=require("dotenv");r.n(s)().config(),Promise.resolve().then(r.bind(r,433)).then((({StartService:e})=>{e()}))})();