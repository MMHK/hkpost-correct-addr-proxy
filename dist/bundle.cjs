(()=>{"use strict";var e={783:(e,t,r)=>{r.r(t),r.d(t,{StartService:()=>u,default:()=>f});const s=require("fastify"),i=require("@fastify/swagger"),n=require("@fastify/swagger-ui"),o=require("axios"),a=require("cheerio"),c=process.env.API_ENDPOINT||"https://webapp.hongkongpost.hk/correct_addressing";function l(e,t){const r=(0,a.load)(e),s=[],i=[];return r(t).find("th").each(((e,t)=>{i.push(r(t).text().trim().replace("null",""))})),r(t).find("tr").each(((e,t)=>{if(0!==e){const e={};r(t).find("td").each(((t,s)=>{const n=i[t],o=/\(([^)]+)\)/i,a=r(s).text().trim()||"",c=o.exec(a);c&&(e[`${n}-en`]=a.replace(o,"").trim(),e[`${n}-zh`]=(c[1]||"").trim())})),s.push(e)}})),s.filter((e=>e)).map((e=>Object.fromEntries(Object.entries(e).filter((([e,t])=>e))))).filter((e=>Object.keys(e).length>0))}const p={scoreStrings:function(e,t){return e.reduce(((e,r)=>{const s=new RegExp(`(${r})`,"ig");return e+(t.match(s)||[]).length}),0)},async getBuildingAddress(e={building:""}){const t={iseng:"true",n:4,a:1,currpage:1,lang1:"en",...e},r=new URLSearchParams;return Object.entries(t).forEach((([e,t])=>{r.append(e,t)})),l((await o.get(`${c}/GetBuildingAddr.jsp?${r.toString()}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}})).data||"",".tableb")},async getStreetAddress(e={street:"",key:""}){const t={iseng:"true",n:50,a:1,currpage:1,lang1:"en",...e},r=new URLSearchParams;return Object.entries(t).forEach((([e,t])=>{r.append(e,t)})),l((await o.get(`${c}/GetStreetAddr.jsp?${r.toString()}`,{headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/116.0.0.0 Safari"}})).data||"",".tables")}},d=async(e,t)=>{if(!process.env.AUTH_TOKEN)return;const{headers:r}=e,s=r.authorization;return s&&s===process.env.AUTH_TOKEN?void 0:(console.error("Unauthorized"),t.send({text:"Unauthorized"},406))},g=s({bodyLimit:10485760,logger:{transport:{target:"@fastify/one-line-logger"}}}),u=async(e=null)=>{e||(e=process.env.PORT||3e3),await(async e=>{await e.register(i,{swagger:{mode:"dynamic",info:{title:"Proxy for HongKong Post Correct Addressing Services",description:"透過此 API 寻找正确的香港地址",version:"1.0.0"},consumes:["application/json"],produces:["application/json"],securityDefinitions:{bearerAuth:{type:"apiKey",schema:"bearer",name:"Authorization",in:"header"}}}}),await e.addHook("onRequest",((t,r,s)=>{let i=t.headers["x-forwarded-host"]||t.headers.host;t.headers["x-forwarded-proto"]||t.protocol,`${i}`.includes(",")&&(i=i.split(",")[0]),e.swagger().host=`${i}`,s()}))})(g),await(e=>e.register(n,{routePrefix:"/swagger",uiConfig:{docExpansion:"full",deepLinking:!1},uiHooks:{onRequest:function(e,t,r){r()},preHandler:function(e,t,r){r()}},staticCSP:!0,transformStaticCSP:e=>e,transformSpecification:(e,t,r)=>e,exposeRoute:!0}))(g),(e=>{e.get("/",{schema:{hide:!0}},(async(e,t)=>t.redirect("/swagger"))),e.get("/api/lookup",{preHandler:d,schema:{security:process.env.AUTH_TOKEN?[{bearerAuth:[]}]:void 0,tags:["HKPost"],summary:"透過此 API 尋找正確的香港地址",consumes:["application/json"],querystring:{type:"object",properties:{street:{type:"string",description:"街道或者屋邨名(不帶編號)"},building:{type:"string",description:"樓宇/大廈/建築名稱"},estate:{type:"string",description:"屋邨名稱"}}},response:{default:{type:"object",properties:{status:{type:"boolean",description:"是否成功"},result:{type:"array",description:"結果",items:{type:"object",properties:{district:{type:"string",description:"地區"},street:{type:"string",description:"街道"},building:{type:"string",description:"大廈/建築名稱"},score:{type:"number",description:"相似度"}}}},error:{type:"string",description:"錯誤信息"}}}}}},(async(e,t)=>{let{street:r,building:s,estate:i}=e.query;r=(r||"").replace(/(rd|road|st|street)$/gi,""),s=(s||"").replace(/(house|building)$/gi,""),i=(i||"").replace(/(estate)$/gi,"");try{let e=[],n=Array.from(new Set([s,i].map((e=>e.replace(/(the|park|tower)/gi,"").split(/\W+/))).flat(1))).filter((e=>e)),o=!1;r&&(0===n.length&&(n=[""]),e=await Promise.all(n.map((e=>p.getStreetAddress({street:r,key:e})))),e.filter((e=>e instanceof Array&&e.length>0)).length>0&&(o=!0)),o||(n=[s,i].map((e=>e.replace(/(the|park|tower)/gi,"").trim())).filter((e=>e)),n.length>0&&(e=await Promise.all(n.map((e=>p.getBuildingAddress({building:e}))))));let a=e.filter((e=>e instanceof Array&&e.length>0)).reduce(((e,t)=>e.concat(t)),[]).map((e=>[`${e["District-en"]||""}${e["Street-en"]||""}${e["Building-en"]||""}`,e]));return e=Object.values(Object.fromEntries(a)),n=n.map((e=>e.split(/\W+/))).flat(1).filter((e=>e)),console.log("search keys",n),e=e.map((e=>{let t={...e,"District-en":"","District-zh":""};const r=p.scoreStrings(n,JSON.stringify(t));return{...e,score:r}})).sort(((e,t)=>t.score-e.score)),console.log(e),e instanceof Array&&e.length>0?t.status(200).send({status:!0,result:e.map((e=>({district:e["District-en"]||"",street:e["Street-en"]||"",building:e["Building-en"]||"",score:e.score||0})))}):t.status(200).send({status:!1,error:"找不到相關地址"})}catch(e){return t.status(500).send({status:!1,error:e.message})}}))})(g),await g.ready(),g.listen({host:"0.0.0.0",port:e},((e,t)=>{e&&(console.error(e),process.exit(1)),console.log(`Server listening at ${t}`)}))},f=u}},t={};function r(s){var i=t[s];if(void 0!==i)return i.exports;var n=t[s]={exports:{}};return e[s](n,n.exports,r),n.exports}r.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return r.d(t,{a:t}),t},r.d=(e,t)=>{for(var s in t)r.o(t,s)&&!r.o(e,s)&&Object.defineProperty(e,s,{enumerable:!0,get:t[s]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})};const s=require("dotenv");r.n(s)().config(),Promise.resolve().then(r.bind(r,783)).then((({StartService:e})=>{e()}))})();